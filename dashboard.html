<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard — HeartLink</title>
  <style>
    :root{--accent:#ff4d88;--muted:#6b6b6b;--bg:#fff7fb;font-family:Inter,system-ui,Arial}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:#1b1330;min-height:100vh;display:flex;flex-direction:column}
    header{background:white;padding:12px 20px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.04);position:sticky;top:0;z-index:20}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .logo{width:36px;height:36px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#ff9ab8);display:grid;place-items:center;color:white;font-weight:700}
    nav{display:flex;gap:12px;align-items:center}
    nav a{padding:8px 12px;border-radius:10px;text-decoration:none;color:#333;font-weight:600}
    nav a.active{background:linear-gradient(90deg,var(--accent),#ff7aa6);color:white}
    .notif-badge{background:#ff3b7a;color:white;padding:4px 8px;border-radius:999px;font-weight:700;margin-left:6px}

    main{display:grid;grid-template-columns:1fr 2fr 1fr;gap:18px;padding:22px}
    .card{background:white;border-radius:12px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    .profile-summary{display:flex;gap:14px;align-items:center}
    .profile-summary img{width:84px;height:84px;border-radius:12px;object-fit:cover;border:3px solid var(--accent)}
    .profile-actions{display:flex;gap:8px;margin-top:12px}
    .btn{background:var(--accent);color:white;border:0;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    .muted{color:var(--muted)}

    /* collapsible card header */
    .card-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer}
    .card-body{margin-top:12px}
    .collapsed .card-body{display:none}

    /* Matches grid */
    .matches-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .match-card{padding:10px;border-radius:10px;border:1px solid #eee;background:#fff;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px}
    .match-card img{width:100%;height:110px;object-fit:cover;border-radius:8px}
    .match-actions{display:flex;gap:8px;width:100%}
    .small-btn{background:#f4f4f4;color:#333;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}

    /* Chats */
    .chat-item{display:flex;gap:10px;align-items:center;padding:8px;border-bottom:1px solid #f2f2f2}
    .chat-item img{width:48px;height:48px;border-radius:10px;object-fit:cover}

    /* Responsive */
    @media(max-width:980px){main{grid-template-columns:1fr;}}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:none;align-items:center;justify-content:center}
    .modal.open{display:flex}
    .modal-card{background:white;padding:20px;border-radius:12px;width:90%;max-width:520px}
    .field{display:flex;flex-direction:column;margin-bottom:10px}
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">❤</div>
      <div style="font-weight:700">HeartLink</div>
    </div>

    <nav id="mainNav">
      <a href="#" id="nav-home" class="active">Home</a>
      <a href="#" id="nav-matches">Matches <span id="matches-count" class="muted" style="font-weight:600;margin-left:6px">(50)</span></a>
      <a href="#" id="nav-chats">Chats</a>
      <a href="#" id="nav-settings">Settings</a>
      <a href="#" id="nav-logout">Logout</a>
      <span style="margin-left:12px">Notifications <span id="notifBadge" class="notif-badge">0</span></span>
    </nav>
  </header>

  <main>
    <!-- Left column: Profile & Likes -->
    <section>
      <div class="card" id="profileCard">
        <div class="card-header" data-collapse>
          <strong>Your Profile</strong>
          <div><button class="small-btn" id="editProfile">Edit</button></div>
        </div>
        <div class="card-body">
          <div class="profile-summary">
            <img id="pfImg" src="https://via.placeholder.com/84" alt="profile" />
            <div>
              <div id="pfName"><strong>Loading...</strong></div>
              <div id="pfMeta" class="muted">—</div>
              <div class="profile-actions">
                <button class="btn" id="viewProfile">View</button>
                <button class="small-btn" id="upgrade">Upgrade</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="likesCard" style="margin-top:14px">
        <div class="card-header" data-collapse>
          <strong>Likes</strong>
          <div class="muted">Received / Sent</div>
        </div>
        <div class="card-body">
          <p class="muted">You have <strong id="likesReceived">0</strong> likes received and <strong id="likesSent">0</strong> sent.</p>
        </div>
      </div>
    </section>

    <!-- Center column: Matches & Chats area (dynamic) -->
    <section id="centerCol">
      <div class="card" id="matchesSection">
        <div class="card-header"><strong>Match Suggestions</strong><div>
          <label class="muted">Show:</label>
          <select id="matchFilter" style="margin-left:8px;padding:6px;border-radius:8px;border:1px solid #eee">
            <option value="opposite">Opposite</option>
            <option value="both">Both</option>
          </select>
        </div></div>
        <div class="card-body">
          <div class="matches-grid" id="matchesGrid">
            <!-- matches inserted here -->
          </div>
        </div>
      </div>

      <div class="card" id="chatsSection" style="margin-top:14px;display:none">
        <div class="card-header"><strong>Chats</strong><div></div></div>
        <div class="card-body" id="chatsList">
          <!-- chats inserted here -->
        </div>
      </div>
    </section>

    <!-- Right column: Notifications & Daily Tip -->
    <section>
      <div class="card" id="notifCard">
        <div class="card-header" data-collapse>
          <strong>Notifications</strong>
          <div id="clearNotifsWrap"><button class="small-btn" id="clearNotifs">Clear</button></div>
        </div>
        <div class="card-body" id="notifList">
          <div class="muted">Loading notifications…</div>
        </div>
      </div>

      <div class="card" style="margin-top:14px" id="tipCard">
        <div class="card-header" data-collapse>
          <strong>Daily Compatibility Tip</strong>
        </div>
        <div class="card-body"><p id="dailyTip">Loading tip…</p></div>
      </div>
    </section>
  </main>

  <footer style="padding:14px;text-align:center;color:var(--muted);background:white;border-top:1px solid #eee">© 2025 HeartLink</footer>

  <!-- Profile / Match modal -->
  <div class="modal" id="modal">
    <div class="modal-card" role="dialog" aria-modal="true">
      <div id="modalContent">Loading…</div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
        <button class="small-btn" id="modalClose">Close</button>
        <button class="btn" id="modalLike">Like</button>
        <button class="btn" id="modalChat">Chat</button>
      </div>
    </div>
  </div>

  <!-- Edit profile modal -->
  <div class="modal" id="editModal">
    <div class="modal-card">
      <h3>Edit Profile</h3>
      <div class="field"><label>Name</label><input id="modalName" type="text"></div>
      <div class="field"><label>Meta (age • location)</label><input id="modalMeta" type="text"></div>
      <div class="field"><label>Profile image URL</label><input id="modalImg" type="text"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
        <button class="small-btn" id="modalCancel">Cancel</button>
        <button class="btn" id="modalSave">Save</button>
      </div>
    </div>
  </div>

  <script>
    // Production-ready fetch wrapper (assumes JSON responses)
    const API_BASE = '/api';
    function apiFetch(path, options = {}){
      const token = localStorage.getItem('token');
      const headers = options.headers || {};
      headers['Content-Type'] = headers['Content-Type'] || 'application/json';
      if(token) headers['Authorization'] = 'Bearer ' + token;
      return fetch(API_BASE + path, {...options, headers})
        .then(async res => {
          if(res.status === 401){
            // unauthorized — clear token and redirect to login
            localStorage.removeItem('token');
            window.location.href = 'index.html';
            throw new Error('Unauthorized');
          }
          const text = await res.text();
          try{ return JSON.parse(text); } catch(e){ return text; }
        });
    }

    // State
    let currentUser = null;
    let currentModalProfile = null;
    let notifInterval = null;

    // Elements
    const pfName = document.getElementById('pfName');
    const pfMeta = document.getElementById('pfMeta');
    const pfImg = document.getElementById('pfImg');
    const matchesGrid = document.getElementById('matchesGrid');
    const chatsList = document.getElementById('chatsList');
    const notifBadge = document.getElementById('notifBadge');
    const notifList = document.getElementById('notifList');
    const likesReceivedEl = document.getElementById('likesReceived');
    const likesSentEl = document.getElementById('likesSent');
    const dailyTipEl = document.getElementById('dailyTip');

    // Nav elements
    const navHome = document.getElementById('nav-home');
    const navMatches = document.getElementById('nav-matches');
    const navChats = document.getElementById('nav-chats');
    const navSettings = document.getElementById('nav-settings');
    const navLogout = document.getElementById('nav-logout');

    // Modal elements
    const modal = document.getElementById('modal');
    const modalContent = document.getElementById('modalContent');
    const modalClose = document.getElementById('modalClose');
    const modalLike = document.getElementById('modalLike');
    const modalChat = document.getElementById('modalChat');

    const editModal = document.getElementById('editModal');
    const editProfileBtn = document.getElementById('editProfile');
    const modalName = document.getElementById('modalName');
    const modalMeta = document.getElementById('modalMeta');
    const modalImg = document.getElementById('modalImg');
    const modalCancel = document.getElementById('modalCancel');
    const modalSave = document.getElementById('modalSave');

    // initialize app
    async function init(){
      try{
        const user = await apiFetch('/user');
        currentUser = user;
        renderProfile(user);
        // load related data
        await Promise.all([loadMatches(), loadChats(), loadNotifications(), loadDailyTip(), loadLikes()]);
        // start polling notifications every 10s
        notifInterval = setInterval(loadNotifications, 10000);
      }catch(err){
        console.error('init error', err);
      }
    }

    function renderProfile(user){
      pfName.innerHTML = '<strong>' + (user.name || '—') + '</strong>';
      pfMeta.textContent = (user.age? user.age + ' • ':'') + (user.location || '—');
      pfImg.src = user.image || 'https://via.placeholder.com/84';
    }

    // Load matches with gender filtering logic + UI filter selection
    async function loadMatches(){
      if(!currentUser) return;
      const filter = document.getElementById('matchFilter').value; // 'opposite' or 'both'
      let genderParam = '';
      if(filter === 'both'){
        genderParam = '';
      } else {
        // opposite of user's gender
        const g = (currentUser.gender || '').toLowerCase();
        if(g === 'male') genderParam = 'female';
        else if(g === 'female') genderParam = 'male';
        else genderParam = ''; // non-binary/other -> treat as both
      }
      const query = genderParam ? '?gender=' + encodeURIComponent(genderParam) : '';
      try{
        const matches = await apiFetch('/matches' + query);
        renderMatches(matches || []);
      }catch(err){
        console.error('loadMatches', err);
      }
    }

    function renderMatches(list){
      matchesGrid.innerHTML = '';
      if(!list.length){ matchesGrid.innerHTML = '<div class="muted">No matches found.</div>'; return; }
      list.forEach(p =>{
        const card = document.createElement('div');
        card.className = 'match-card';
        const img = document.createElement('img'); img.src = p.image || 'https://via.placeholder.com/250';
        const name = document.createElement('div'); name.innerHTML = '<strong>'+p.name+'</strong><div class="muted">'+(p.age? p.age+' • ':'') + (p.location||'')+'</div>';
        const actions = document.createElement('div'); actions.className='match-actions';
        const viewBtn = document.createElement('button'); viewBtn.className='small-btn'; viewBtn.textContent='View';
        viewBtn.onclick = ()=> openProfileModal(p);
        const likeBtn = document.createElement('button'); likeBtn.className='small-btn'; likeBtn.textContent='Like';
        likeBtn.onclick = async (e)=>{ e.stopPropagation(); await likeProfile(p.id); };
        const chatBtn = document.createElement('button'); chatBtn.className='small-btn'; chatBtn.textContent='Chat';
        chatBtn.onclick = ()=> openChatWith(p.id, p.name);
        actions.append(viewBtn, likeBtn, chatBtn);
        card.append(img, name, actions);
        matchesGrid.appendChild(card);
      });
    }

    // Like a profile
    async function likeProfile(targetId){
      try{
        await apiFetch('/like', { method: 'POST', body: JSON.stringify({ targetId }) });
        // increment sent likes locally
        likesSentEl.textContent = (parseInt(likesSentEl.textContent)||0) + 1;
        alert('Liked!');
      }catch(err){ console.error('like error', err); alert('Could not like right now.'); }
    }

    // Chats
    async function loadChats(){
      try{
        const chats = await apiFetch('/chats');
        renderChats(chats || []);
      }catch(err){ console.error('loadChats', err); }
    }
    function renderChats(list){
      chatsList.innerHTML='';
      if(!list.length){ chatsList.innerHTML='<div class="muted">No chats yet.</div>'; return; }
      list.forEach(c=>{
        const item = document.createElement('div'); item.className='chat-item';
        item.innerHTML = `<img src="${c.image||'https://via.placeholder.com/48'}"><div><strong>${c.name}</strong><div class=\"muted\">${c.lastMessage||''}</div></div>`;
        const openBtn = document.createElement('button'); openBtn.className='small-btn'; openBtn.textContent='Open';
        openBtn.onclick = ()=> openChatWith(c.id, c.name);
        item.appendChild(openBtn);
        chatsList.appendChild(item);
      });
    }

    function openChatWith(id, name){
      // simple chat composer modal
      const message = prompt('Message to ' + name + ':');
      if(message){
        apiFetch('/chat/' + encodeURIComponent(id), { method: 'POST', body: JSON.stringify({ message }) })
          .then(()=>{ alert('Message sent'); loadChats(); })
          .catch(()=>alert('Failed to send message'));
      }
    }

    // Notifications
    async function loadNotifications(){
      try{
        const notifs = await apiFetch('/notifications');
        renderNotifications(notifs || []);
      }catch(err){ console.error('loadNotifications', err); }
    }
    function renderNotifications(list){
      notifList.innerHTML='';
      if(!list.length){ notifList.innerHTML='<div class="muted">No new notifications — yet.</div>'; notifBadge.textContent='0'; return; }
      notifBadge.textContent = list.length;
      list.forEach(n =>{
        const el = document.createElement('div'); el.className='muted'; el.textContent = n.text; notifList.appendChild(el);
      });
    }

    document.getElementById('clearNotifs').addEventListener('click', async ()=>{
      try{
        await apiFetch('/notifications/clear', { method: 'POST' });
        notifList.innerHTML='<div class="muted">No new notifications — yet.</div>';
        notifBadge.textContent='0';
      }catch(err){ console.error('clear notifs', err); }
    });

    // editable profile modal
    editProfileBtn.addEventListener('click', ()=>{
      editModal.classList.add('open');
      modalName.value = currentUser.name || '';
      modalMeta.value = (currentUser.age? currentUser.age + ' • ':'') + (currentUser.location||'');
      modalImg.value = currentUser.image || '';
    });
    modalCancel.addEventListener('click', ()=> editModal.classList.remove('open'));
    modalSave.addEventListener('click', async ()=>{
      const payload = { name: modalName.value, meta: modalMeta.value, image: modalImg.value };
      try{
        await apiFetch('/profile', { method: 'PUT', body: JSON.stringify(payload) });
        // update UI
        currentUser.name = payload.name;
        currentUser.location = payload.meta;
        currentUser.image = payload.image;
        renderProfile(currentUser);
        editModal.classList.remove('open');
        alert('Profile updated');
      }catch(err){ console.error('save profile', err); alert('Failed to update profile'); }
    });

    // Profile / match modal open
    function openProfileModal(profile){
      currentModalProfile = profile;
      modalContent.innerHTML = `<div style="display:flex;gap:12px"><img src=\"${profile.image||'https://via.placeholder.com/120'}\" style=\"width:120px;height:120px;object-fit:cover;border-radius:12px\"><div><h3>${profile.name}</h3><div class=\"muted\">${profile.age?profile.age+' • ':''}${profile.location||''}</div><p class=\"muted\">${profile.bio||''}</p></div></div>`;
      modal.classList.add('open');
    }
    modalClose.addEventListener('click', ()=> modal.classList.remove('open'));

    modalLike.addEventListener('click', async ()=>{
      if(!currentModalProfile) return;
      try{ await apiFetch('/like', { method: 'POST', body: JSON.stringify({ targetId: currentModalProfile.id }) }); alert('Liked!'); modal.classList.remove('open'); }
      catch(e){ alert('Could not like'); }
    });
    modalChat.addEventListener('click', ()=>{
      if(!currentModalProfile) return;
      modal.classList.remove('open');
      openChatWith(currentModalProfile.id, currentModalProfile.name);
    });

    // Upgrade
    document.getElementById('upgrade').addEventListener('click', async ()=>{
      if(!confirm('Upgrade to Premium?')) return;
      try{
        const res = await apiFetch('/upgrade', { method: 'POST', body: JSON.stringify({ plan: 'premium' }) });
        if(res && res.newStatus){
          alert('Upgraded to ' + res.newStatus);
          // update UI
          // e.g., show premium badge — simplified here
        }
      }catch(err){ console.error('upgrade', err); alert('Upgrade failed'); }
    });

    // Logout
    document.getElementById('nav-logout').addEventListener('click', (e)=>{
      e.preventDefault(); localStorage.removeItem('token'); window.location.href='index.html';
    });

    // Nav handlers
    function setActive(link){
      document.querySelectorAll('nav a').forEach(a=>a.classList.remove('active'));
      link.classList.add('active');
    }
    navHome.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navHome); document.getElementById('matchesSection').style.display='block'; document.getElementById('chatsSection').style.display='none'; });
    navMatches.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navMatches); document.getElementById('matchesSection').style.display='block'; document.getElementById('chatsSection').style.display='none'; loadMatches(); });
    navChats.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navChats); document.getElementById('matchesSection').style.display='none'; document.getElementById('chatsSection').style.display='block'; loadChats(); });
    navSettings.addEventListener('click', (e)=>{ e.preventDefault(); setActive(navSettings); alert('Settings panel would open here (placeholder).'); });

    // Collapsible cards
    document.querySelectorAll('[data-collapse]').forEach(hdr=>{
      hdr.addEventListener('click', ()=> hdr.parentElement.classList.toggle('collapsed'));
    });

    // match filter change
    document.getElementById('matchFilter').addEventListener('change', loadMatches);

    // Start
    init();

    // Close modals by clicking outside
    document.querySelectorAll('.modal').forEach(m=>m.addEventListener('click', (e)=>{ if(e.target===m) m.classList.remove('open'); }));
  </script>
</body>
</html>
